#!/bin/sh

COLOR_ARROW=$(tput setaf 5)
COLOR_MSG=$(tput setaf 2)
COLOR_ERR_ARROW=$(tput setaf 6)
COLOR_ERR_MSG=$(tput setaf 9)
COLOR_RESET=$(tput setaf 7)

_log() {
	printf "%s-->%s %s%s\n" "$COLOR_ARROW" "$COLOR_MSG" "$*" "$COLOR_RESET"
}

_log_err() {
	printf "%s-->%s %s%s\n" "$COLOR_ERR_ARROW" "$COLOR_ERR_MSG" "$*" "$COLOR_RESET"
	exit 1
}

[ -z "$POLOCHON_URL" ] && _log_err "Missing polochon url"
[ -z "$POLOCHON_TOKEN" ] && _log_err "Missing polochon token"

_usage() {
	echo "$(basename "$0"):"
	echo "    m|movie|movies - Choose and stream a movie"
	echo "    s|show|shows   - Choose and stream a show episode"
	exit 0
}

_polochon_call() {
	curl --silent --show-error \
		--compressed \
		-H "X-Auth-Token: $POLOCHON_TOKEN" \
		"$POLOCHON_URL/$1"
}

_fzf() {
	header=$1
	shift
	fzf --prompt="> " \
		--no-multi \
		--header="$header" \
		--color dark,hl:33,hl+:234,fg+:234,bg+:136 \
		--color info:254,prompt:33,spinner:136,pointer:136,marker:136 \
		"$@"
}

_mpv() {
	title=$1
	uri=$2
	subtitles=$3
	filename=$4
	base="${filename%.*}"

	_log "Streaming \"$title\""

	set --
	for lang in $subtitles; do
		short_lang="${lang%%_*}"
		set -- "$@" "--sub-file=$uri/subtitles/$lang/download/${base}.${short_lang}.srt"
		_log "  - $lang"
	done

	mpv \
		--http-header-fields="X-Auth-Token: $POLOCHON_TOKEN" \
		--title="$title" \
		"$@" \
		"$uri/download/$filename"
}

_movies() {
	data=$(_polochon_call "movies")

	title=$(echo "$data" | jq -r '.[] | .title?' | sort | _fzf "Choose the movie")
	[ -n "$title" ] || _log_err "No movie selected"

	movie=$(echo "$data" | jq -rc --arg title "$title" 'to_entries | .[] | select(.value.title == $title)')

	imdb_id=$(jq -rn --argjson m "$movie" '$m.key')
	filename=$(jq -rn --argjson m "$movie" '$m.value.filename')
	subtitles=$(jq -rn --argjson m "$movie" '$m.value.subtitles[] | select(.embedded == false)? | .lang')

	_log "Imdb: https://imdb.com/title/$imdb_id"

	_mpv "$title" "$POLOCHON_URL/movies/$imdb_id" "$subtitles" "$filename"
}

_shows() {
	data=$(_polochon_call "shows")

	title=$(echo "$data" | jq -r '.[] | .title?' | _fzf "Choose the show")
	[ -n "$title" ] || _log_err "No show selected"

	show=$(echo "$data" | jq -rc --arg title "$title" 'to_entries | .[] | select(.value.title == $title)')
	imdb_id=$(jq -rn --argjson s "$show" '$s.key')

	season=$(jq -rn --argjson s "$show" '$s.value.seasons | keys | .[]' | _fzf "Choose the season")
	[ -n "$season" ] || _log_err "No season selected"

	episode=$(jq -rn --argjson s "$show" --arg season "$season" \
		'$s.value.seasons | .[$season] | keys | .[]' | _fzf "Choose the episode")
	[ -n "$episode" ] || _log_err "No episode selected"

	ep=$(jq -rn --argjson s "$show" --arg season "$season" --arg episode "$episode" \
		'$s.value.seasons | .[$season] | .[$episode]')

	filename=$(jq -rn --argjson ep "$ep" '$ep.filename')
	subtitles=$(jq -rn --argjson ep "$ep" '$ep.subtitles[]? | select(.embedded == false) | .lang')

	_log "Imdb: https://imdb.com/title/$imdb_id"

	_mpv "$title S${season}E$episode" \
		"$POLOCHON_URL/shows/$imdb_id/seasons/$season/episodes/$episode" \
		"$subtitles" "$filename"
}

case "$1" in
	m|movie|movies) _movies ;;
	s|show|shows)   _shows  ;;
	*)              _usage  ;;
esac
